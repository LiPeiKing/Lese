# 事务

## 1. 认识事务

### 1.1 为什么需要数据库事务

转账是生活中常见的操作,比如从A账户转账100元到B账号。站在用户角度而言,这是一个逻辑上的单一操作,然而在数据库系统中,至少会分成两个步骤来完成:

- 1.将A账户的金额减少100元
- 2.将B账户的金额增加100元。

![img](https://img2018.cnblogs.com/blog/1422237/201811/1422237-20181122103041637-782687204.png)

在这个过程中可能会出现以下问题:

- 1.转账操作的第一步执行成功,A账户上的钱减少了100元,但是第二步执行失败或者未执行便发生系统崩溃,导致B账户并没有相应增加100元。
- 2.转账操作刚完成就发生系统崩溃,系统重启恢复时丢失了崩溃前的转账记录。
- 3.同时又另一个用户转账给B账户,由于同时对B账户进行操作,导致B账户金额出现异常。

为了便于解决这些问题,需要引入数据库事务的概念。

### 1.2 什么是数据库事务

**定义:数据库事务是构成单一逻辑工作单元的操作集合**
一个典型的数据库事务如下所示

```
BEGIN TRANSACTION  //事务开始
SQL1
SQL2
COMMIT/ROLLBACK   //事务提交或回滚
```

关于事务的定义有几点需要解释下：

- 1.数据库事务可以包含一个或多个数据库操作,但这些操作构成一个逻辑上的整体。
- 2.构成逻辑整体的这些数据库操作,要么全部执行成功,要么全部不执行。
- 3.构成事务的所有操作,要么全都对数据库产生影响,要么全都不产生影响,即不管事务是否执行成功,数据库总能保持一致性状态。
- 4.以上即使在数据库出现故障以及并发事务存在的情况下依然成立。

### 1.3 事务如何解决问题

对于上面的转账例子,可以将转账相关的所有操作包含在一个事务中

```
BEGIN TRANSACTION 
A账户减少100元
B账户增加100元
COMMIT
```

- 1.当数据库操作失败或者系统出现崩溃,系统能够以事务为边界进行恢复,不会出现A账户金额减少而B账户未增加的情况。
- 2.当有多个用户同时操作数据库时,数据库能够以事务为单位进行并发控制,使多个用户对B账户的转账操作相互隔离。

事务使系统能够更方便的进行故障恢复以及并发控制,从而保证数据库状态的一致性。

### 1.4 事务的ACID特性以及实现原理概述

原子性(Atomicity):事务中的所有操作作为一个整体像原子一样不可分割，要么全部成功,要么全部失败。

一致性(Consistency):事务的执行结果必须使数据库从一个一致性状态到另一个一致性状态。一致性状态是指:1.系统的状态满足数据的完整性约束(主码,参照完整性,check约束等) 2.系统的状态反应数据库本应描述的现实世界的真实状态,比如转账前后两个账户的金额总和应该保持不变。

隔离性(Isolation):并发执行的事务不会相互影响,其对数据库的影响和它们串行执行时一样。比如多个用户同时往一个账户转账,最后账户的结果应该和他们按先后次序转账的结果一样。

持久性(Durability):事务一旦提交,其对数据库的更新就是持久的。任何事务或系统故障都不会导致数据丢失。

在事务的ACID特性中,C即一致性是事务的根本追求,而对数据一致性的破坏主要来自两个方面

- 1.事务的并发执行
- 2.事务故障或系统故障

数据库系统是通过并发控制技术和日志恢复技术来避免这种情况发生的。

并发控制技术保证了事务的隔离性,使数据库的一致性状态不会因为并发执行的操作被破坏。
日志恢复技术保证了事务的原子性,使一致性状态不会因事务或系统故障被破坏。同时使已提交的对数据库的修改不会因系统崩溃而丢失,保证了事务的持久性。
![img](https://img2018.cnblogs.com/blog/1422237/201811/1422237-20181122103102223-1059881337.png)

## 2.并发异常与并发控制技术

### 2.1 常见的并发异常

在讲解并发控制技术前,先简单介绍下数据库常见的并发异常。

- 脏写
    脏写是指事务回滚了其他事务对数据项的已提交修改,比如下面这种情况
    ![img](https://img2018.cnblogs.com/blog/1422237/201811/1422237-20181122103114390-240225061.png)

在事务1对数据A的回滚,导致事务2对A的已提交修改也被回滚了。

- 丢失更新
    丢失更新是指事务覆盖了其他事务对数据的已提交修改,导致这些修改好像丢失了一样。
    ![img](https://img2018.cnblogs.com/blog/1422237/201811/1422237-20181122103128561-1407249708.png)

事务1和事务2读取A的值都为10,事务2先将A加上10并提交修改,之后事务2将A减少10并提交修改,A的值最后为,导致事务2对A的修改好像丢失了一样

- 脏读
    脏读是指一个事务读取了另一个事务未提交的数据
    ![img](https://img2018.cnblogs.com/blog/1422237/201811/1422237-20181122103137124-343962409.png)

在事务1对A的处理过程中,事务2读取了A的值,但之后事务1回滚,导致事务2读取的A是未提交的脏数据。

- 不可重复读
    不可重复读是指一个事务对同一数据的读取结果前后不一致。脏读和不可重复读的区别在于:前者读取的是事务未提交的脏数据,后者读取的是事务已经提交的数据,只不过因为数据被其他事务修改过导致前后两次读取的结果不一样,比如下面这种情况
    ![img](https://img2018.cnblogs.com/blog/1422237/201811/1422237-20181122103147288-996731595.png)

由于事务2对A的已提交修改,事务1前后两次读取的结果不一致。

- 幻读
    幻读是指事务读取某个范围的数据时，因为其他事务的操作导致前后两次读取的结果不一致。幻读和不可重复读的区别在于,不可重复读是针对确定的某一行数据而言,而幻读是针对不确定的多行数据。因而幻读通常出现在带有查询条件的范围查询中,比如下面这种情况:
    ![img](https://img2018.cnblogs.com/blog/1422237/201811/1422237-20181122103158043-533492513.png)

事务1查询A<5的数据,由于事务2插入了一条A=4的数据,导致事务1两次查询得到的结果不一样

### 2.2 事务的隔离级别

1. 事务具有隔离性,理论上来说事务之间的执行不应该相互产生影响,其对数据库的影响应该和它们串行执行时一样。
2. 然而完全的隔离性会导致系统并发性能很低,降低对资源的利用率,因而实际上对隔离性的要求会有所放宽,这也会一定程度造成对数据库一致性要求降低
3. SQL标准为事务定义了不同的隔离级别,从低到高依次是

- 读未提交(READ UNCOMMITTED)
- 读已提交(READ COMMITTED)
- 可重复读(REPEATABLE READ)
- 串行化(SERIALIZABLE)

事务的隔离级别越低,可能出现的并发异常越多,但是通常而言系统能提供的并发能力越强。

不同的隔离级别与可能的并发异常的对应情况如下表所示,有一点需要强调,这种对应关系只是理论上的,对于特定的数据库实现不一定准确,比如mysql
的Innodb存储引擎通过Next-Key Locking技术在可重复读级别就消除了幻读的可能。
![img](https://img2018.cnblogs.com/blog/1422237/201811/1422237-20181122103221352-219869675.png)

所有事务隔离级别都不允许出现脏写,而串行化可以避免所有可能出现的并发异常,但是会极大的降低系统的并发处理能力。





## 数据库隔离性分析之为什么会产生脏读？

数据库的物理存储会分成许多个页（Page），记录都存储在页中，数据每一次IO，操作的最小单位是一个页。数据库运行时，会在内存中维护一个缓冲区（Buffer Pool）。缓冲区缓存部分的页（因为内存有限，所有不能把所有数据都缓存进来）。

当一个数据库存在两个事务的时候，例:事务A,事务B,data1=10，两个事务共同修改同一个数据。
当事务A修改数据data1的时，先看pool中是否存在与之对应的页，若不存在，读取磁盘中的页，若存在，则直接使用在pool中的页。事务A将data1修改成为20后，但并未提交commit（其实即使你提交了也不一定会及时的写回磁盘，它只是将你的sql操作记录写回了磁盘日志文件，在最下面来说日志文件的好处），这时事务B开始读取数据data1，但此时data1所在的页已经存在于数据库缓冲区中，则直接进入pool读取data1，但此时的数据data1属于事务A并未提交的数据，属于无效数据，也就是我们Mysql中常说的的脏数据啦。

如图：数据库缓冲区Pool

![数据库缓冲区Pool](https://img-blog.csdnimg.cn/20191125223605592.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDkzOTQyNA==,size_16,color_FFFFFF,t_70)

